<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Map Navigator 3D ‚Äî Plug & Play</title>

<!-- CesiumJS -->
<link href="https://cesium.com/downloads/cesiumjs/releases/1.119/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
<script src="https://cesium.com/downloads/cesiumjs/releases/1.119/Build/Cesium/Cesium.js"></script>

<style>
html, body, #cesiumContainer { width:100%; height:100%; margin:0; padding:0; overflow:hidden; }
#panel{
  position:absolute;top:1rem;left:1rem;z-index:1000;
  backdrop-filter: blur(12px);
  background: rgba(255,255,255,0.75);
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.25);
  padding: 16px 18px;
  width: 320px;
  font-family: "Inter","Segoe UI",sans-serif;
}
h3{margin:.4rem 0;font-size:1rem;font-weight:600;}
input{width:100%;margin:4px 0;padding:8px;border:1px solid #ccc;border-radius:8px;}
button{
  background:#0078ff;color:white;border:none;
  border-radius:8px;padding:8px 12px;margin:4px 4px 8px 0;
  cursor:pointer;font-weight:600;transition:background .2s;
}
button:hover{background:#005ecb;}
#info{margin-top:6px;font-weight:600;font-size:0.85rem;}
hr{margin:10px 0;border:none;border-top:1px solid #ccc;}
footer{
  position:absolute;bottom:10px;left:50%;transform:translateX(-50%);
  background:rgba(255,255,255,0.6);backdrop-filter:blur(6px);
  border-radius:8px;font-size:0.75rem;padding:4px 10px;color:#333;
}
</style>
</head>

<body>
<div id="cesiumContainer"></div>

<div id="panel">
  <h3>üåç Search City (3D)</h3>
  <input id="searchCity" placeholder="e.g. Hyde Park London">
  <button id="searchBtn">Fly To</button>
  <hr>
  <h3>üß≠ Route</h3>
  <input id="from" placeholder="From (city)">
  <input id="to" placeholder="To (city)">
  <button id="routeBtn">Draw Route</button>
  <button id="clearBtn" style="background:#888;">Clear</button>
  <div id="info"></div>
</div>

<footer>Map Navigator ‚Ä¢ C++ √ó Cesium √ó OpenStreetMap</footer>

<script>
// ---------- Cesium setup ----------
Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJjY2U2MmMxOS1jMDdiLTQ5MDQtOTY2OS1iM2ZlMWE5ZDU0YzMiLCJpZCI6MzU4Mzg0LCJpYXQiOjE3NjI1OTM2MjR9.VJVAnwIlSDtRFas3zOAOB0HDtTSARiOvwjKPdOtkEZQ";
 // no account needed

const viewer = new Cesium.Viewer("cesiumContainer", {
  terrain: Cesium.Terrain.fromWorldTerrain(),
  baseLayerPicker: false,
  geocoder: false,
  sceneMode: Cesium.SceneMode.SCENE3D,
  timeline: false,
  animation: false,
});

// Replace Cesium Ion imagery with free OpenStreetMap
viewer.imageryLayers.removeAll();
viewer.imageryLayers.addImageryProvider(
  new Cesium.UrlTemplateImageryProvider({
    url: "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
    credit: "¬© OpenStreetMap contributors"
  })
);
viewer.scene.globe.enableLighting = true;

// ---------- helpers ----------
async function geocode(place){
  const res = await fetch(`/geocode?place=${encodeURIComponent(place)}`);
  const data = await res.json();
  if(!data.length) throw new Error("Place not found");
  const p = data[0];
  return [parseFloat(p.lon), parseFloat(p.lat), p.display_name];
}
async function getRoute(slon,slat,dlon,dlat){
  const res=await fetch(`/route?srcLon=${slon}&srcLat=${slat}&dstLon=${dlon}&dstLat=${dlat}`);
  return res.json();
}

// ---------- City search ----------
document.getElementById("searchBtn").onclick = async ()=>{
  const q = document.getElementById("searchCity").value.trim();
  if(!q){alert("Enter a city");return;}
  try{
    const [lon,lat,name] = await geocode(q);
    viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(lon, lat, 8000),
      orientation:{pitch: Cesium.Math.toRadians(-25)}
    });
    viewer.entities.add({
      position: Cesium.Cartesian3.fromDegrees(lon, lat),
      point: { pixelSize:10, color:Cesium.Color.RED },
      label: { text:name, pixelOffset:new Cesium.Cartesian2(0,-25), fillColor:Cesium.Color.WHITE }
    });
  }catch(e){alert("Place not found");}
};

// ---------- Route ----------
document.getElementById("routeBtn").onclick = async ()=>{
  const from=document.getElementById("from").value.trim();
  const to=document.getElementById("to").value.trim();
  if(!from||!to){alert("Enter both");return;}
  try{
    const [slon,slat]=await geocode(from);
    const [dlon,dlat]=await geocode(to);
    const data=await getRoute(slon,slat,dlon,dlat);
    const coords=data.coords.map(c=>Cesium.Cartesian3.fromDegrees(c[0],c[1],1000));
    viewer.entities.add({
      polyline:{
        positions:coords,
        width:3,
        material:Cesium.Color.CYAN.withAlpha(0.9)
      }
    });
    viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(slon, slat, 2000000)
    });
    document.getElementById("info").textContent=
      `Distance: ${data.distance_km.toFixed(1)} km | Time: ${data.duration_min.toFixed(1)} min`;
  }catch(e){alert("Routing failed");}
};

// ---------- Clear ----------
document.getElementById("clearBtn").onclick = ()=>{
  viewer.entities.removeAll();
  document.getElementById("info").textContent="";
};
</script>
</body>
</html>
